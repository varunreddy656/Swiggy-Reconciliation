<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Invoice Reconciliation</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap');
    body {
      margin: 0;
      background: #fafafa;
      font-family: 'Montserrat', sans-serif;
      color: #3a3a3a;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      background: #fff;
      max-width: 480px;
      width: 100%;
      padding: 48px 36px;
      border-radius: 18px;
      box-shadow: 0 16px 32px rgba(0, 0, 0, 0.08);
      text-align: center;
      user-select: none;
    }
    h1 {
      margin: 0 0 28px 0;
      font-weight: 600;
      font-size: 2.3rem;
      letter-spacing: 0.04em;
      color: #222;
    }
    label {
      font-weight: 600;
      font-size: 1rem;
      display: block;
      margin-bottom: 10px;
      color: #666;
      text-align: left;
    }
    input[type="text"],
    select {
      width: 100%;
      padding: 14px 18px;
      border: 1.5px solid #ddd;
      border-radius: 14px;
      font-size: 1rem;
      color: #444;
      letter-spacing: 0.02em;
      transition: border 0.25s ease;
      margin-bottom: 30px;
      font-family: 'Montserrat', sans-serif;
    }
    input[type="text"]:focus,
    select:focus {
      border-color: #bfa058;
      outline: none;
      box-shadow: 0 0 12px rgba(191, 160, 88, 0.3);
    }
    .upload-area {
      padding: 40px 20px;
      border: 2.5px dashed #ccc;
      border-radius: 16px;
      color: #999;
      font-size: 1.1rem;
      font-weight: 600;
      letter-spacing: 0.03em;
      cursor: pointer;
      margin-bottom: 40px;
      transition: border-color 0.3s ease, color 0.3s ease, background 0.3s ease;
    }
    .upload-area.dragover {
      background: #f6f1e7;
      border-color: #bfa058;
      color: #7a6a2f;
    }
    button {
      font-family: 'Montserrat', sans-serif;
      font-weight: 700;
      font-size: 1.15rem;
      width: 100%;
      padding: 16px 0;
      border-radius: 14px;
      border: none;
      background: linear-gradient(135deg, #c7b370, #a58c2a);
      color: #fff;
      letter-spacing: 0.05em;
      box-shadow: 0 8px 20px rgba(165, 140, 42, 0.45);
      cursor: pointer;
      transition: background 0.3s ease, box-shadow 0.3s ease;
    }
    button:disabled {
      background: #d9d7d0;
      box-shadow: none;
      cursor: not-allowed;
      color: #9a9589;
    }
    button:not(:disabled):hover {
      background: linear-gradient(135deg, #b59e48, #8c751d);
      box-shadow: 0 10px 32px rgba(140, 117, 29, 0.60);
    }
    .file-list {
      margin-bottom: 30px;
      max-height: 140px;
      overflow-y: auto;
      background: #f9f7f3;
      border-radius: 12px;
      border: 1px solid #ded9cd;
      padding: 14px 20px;
      font-size: 1rem;
      letter-spacing: 0.02em;
      text-align: left;
      color: #4a4a4a;
    }
    .file-item {
      margin-bottom: 12px;
      padding: 10px 14px;
      border-radius: 10px;
      background: #efece3;
      box-shadow: inset 0 1px 3px rgba(189, 174, 124, 0.3);
      transition: background 0.2s ease;
      user-select: text;
    }
    .file-item:last-child {
      margin-bottom: 0;
    }
    .file-item:hover {
      background: #d4cbac;
      cursor: default;
    }
    .status {
      font-weight: 600;
      font-size: 1.05rem;
      margin-top: 20px;
      border-radius: 12px;
      padding: 14px 22px;
      display: none;
      user-select: none;
      line-height: 1.3;
      letter-spacing: 0.03em;
      max-width: 480px;
      margin-left: auto;
      margin-right: auto;
    }
    .status.success {
      display: block;
      color: #39531d;
      background: #e1eccd;
      border-left: 6px solid #a8c65a;
      box-shadow: 0 4px 20px rgba(168,198,90,0.28);
    }
    .status.error {
      display: block;
      color: #542323;
      background: #f4d6d6;
      border-left: 6px solid #c75a5a;
      box-shadow: 0 4px 20px rgba(199,90,90,0.28);
    }
    .progress {
      background-color: #eee;
      border-radius: 12px;
      overflow: hidden;
      height: 20px;
      margin-bottom: 30px;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
      display: none;
      max-width: 480px;
      margin-left: auto;
      margin-right: auto;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(135deg, #c7b370, #a58c2a);
      text-align: center;
      color: white;
      font-weight: 700;
      font-size: 0.95rem;
      transition: width 0.3s;
      line-height: 20px;
      user-select: none;
    }
  </style>
</head>
<body>
  <div class="container" role="main" aria-label="Invoice Reconciliation Form">
    <h1>Invoice Reconciliation Automation</h1>
    <form id="uploadForm" enctype="multipart/form-data" aria-describedby="instructions">
      <div class="input-group">
        <label for="clientName">Client Name (Optional):</label>
        <input type="text" id="clientName" name="clientName" placeholder="Enter client name here" aria-label="Client name input" />
      </div>

      <div class="input-group">
        <label for="month">Month (Required):</label>
        <select id="month" name="month" aria-label="Select month" required>
          <option value="">-- Select a month --</option>
          <option value="January">January</option>
          <option value="February">February</option>
          <option value="March">March</option>
          <option value="April">April</option>
          <option value="May">May</option>
          <option value="June">June</option>
          <option value="July">July</option>
          <option value="August">August</option>
          <option value="September">September</option>
          <option value="October">October</option>
          <option value="November">November</option>
          <option value="December">December</option>
        </select>
      </div>

      <div class="upload-area" id="uploadArea" tabindex="0" aria-label="Drag and drop area for invoice Excel files" role="button" aria-describedby="uploadInstructions">
        Drag and drop invoice Excel files here, or click to browse
        <input type="file" id="fileInput" name="invoices" multiple accept=".xlsx" hidden aria-hidden="true" />
      </div>
      <div class="file-list" id="fileList" role="list"></div>

      <div class="progress" id="progressContainer" aria-label="Upload progress">
        <div class="progress-bar" id="progressBar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">0%</div>
      </div>

      <button type="submit" id="submitButton" disabled aria-disabled="true" aria-live="polite" aria-atomic="true">Process Invoices</button>
    </form>
    <div class="status" id="status" role="alert" aria-live="assertive" aria-atomic="true"></div>
  </div>

  <script>
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const submitButton = document.getElementById('submitButton');
    const uploadForm = document.getElementById('uploadForm');
    const status = document.getElementById('status');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const monthInput = document.getElementById('month');

    function updateFileList() {
      const files = Array.from(fileInput.files);
      const monthSelected = monthInput.value !== '';

      if (files.length === 0 || !monthSelected) {
        fileList.innerHTML = '';
        submitButton.disabled = true;
        submitButton.setAttribute('aria-disabled', 'true');
        return;
      }
      fileList.innerHTML = files.map(f => `<div class="file-item" role="listitem">${f.name}</div>`).join('');
      submitButton.disabled = false;
      submitButton.removeAttribute('aria-disabled');
      status.style.display = 'none';
      status.textContent = '';
      progressContainer.style.display = 'none';
      progressBar.style.width = '0%';
      progressBar.setAttribute('aria-valuenow', 0);
      progressBar.textContent = '0%';
    }

    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      fileInput.files = e.dataTransfer.files;
      updateFileList();
    });
    fileInput.addEventListener('change', updateFileList);
    monthInput.addEventListener('change', updateFileList);

    uploadForm.addEventListener('submit', (e) => {
      e.preventDefault();
      if (fileInput.files.length === 0 || monthInput.value === '') return;

      submitButton.disabled = true;
      submitButton.setAttribute('aria-disabled', 'true');
      submitButton.textContent = 'Processing...';
      status.style.display = 'none';
      status.textContent = '';

      const formData = new FormData(uploadForm);
      const xhr = new XMLHttpRequest();

      progressContainer.style.display = 'block';
      progressBar.style.width = '0%';
      progressBar.setAttribute('aria-valuenow', 0);
      progressBar.textContent = '0%';

      xhr.upload.addEventListener('progress', (event) => {
        if (event.lengthComputable) {
          const percentComplete = Math.round((event.loaded / event.total) * 100);
          progressBar.style.width = percentComplete + '%';
          progressBar.setAttribute('aria-valuenow', percentComplete);
          progressBar.textContent = percentComplete + '%';
        }
      });

      xhr.onreadystatechange = function () {
        if (xhr.readyState === XMLHttpRequest.DONE) {
          progressContainer.style.display = 'none';

          if (xhr.status >= 200 && xhr.status < 300) {
            const disposition = xhr.getResponseHeader('Content-Disposition');
            let filename = 'Reconciliation.xlsx';
            if (disposition && disposition.indexOf('attachment') !== -1) {
              const match = disposition.match(/filename="?([^"]+)"?/);
              if (match) filename = match[1];
            }

            const blob = new Blob([xhr.response], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);

            status.textContent = 'Success! File downloaded.';
            status.className = 'status success';
            uploadForm.reset();
            fileList.innerHTML = '';
            monthInput.value = '';
            submitButton.disabled = true;
            submitButton.setAttribute('aria-disabled', 'true');
          } else {
            let errorMsg = 'Upload failed.';
            try {
              const responseJson = JSON.parse(xhr.responseText);
              if (responseJson.error) errorMsg = responseJson.error;
            } catch (e) {}
            status.textContent = 'Error: ' + errorMsg;
            status.className = 'status error';
            submitButton.disabled = false;
            submitButton.removeAttribute('aria-disabled');
          }
          submitButton.textContent = 'Process Invoices';
        }
      };

      xhr.open('POST', '/upload');
      xhr.responseType = 'arraybuffer';
      xhr.send(formData);
    });
  </script>
</body>
</html>
